<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presenze Polizia Locale - Comune di Salorno</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Fogli di stile per la mappa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- FullCalendar -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    function aggiornaPosizione(formId) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          document.querySelector(`#${formId} input[name=lat]`).value = pos.coords.latitude;
          document.querySelector(`#${formId} input[name=lon]`).value = pos.coords.longitude;
          document.getElementById(formId).submit();
        }, function() {
          alert("Impossibile ottenere la posizione. Attiva il GPS o consenti la localizzazione.");
        });
      } else {
        alert("Geolocalizzazione non supportata dal browser.");
      }
    }
  </script>

  <style>
    /* Assicura che mappa e calendario siano responsive su iPhone */
    #map, #calendar {
      width: 100%;
      max-width: 100%;
      margin-bottom: 20px;
    }
    #calendar {
      height: 400px;
    }
  </style>
</head>
<body>
  <h1>Presenze Polizia Locale - Comune di Salorno</h1>

  <!-- Check-In -->
  <form id="formCheckin" action="/checkin" method="POST" onsubmit="event.preventDefault(); aggiornaPosizione('formCheckin');">
    <input type="text" name="nome" placeholder="Nome agente" required>
    <input type="hidden" name="lat">
    <input type="hidden" name="lon">
    <button type="submit">Check-In</button>
  </form>

  <!-- Check-Out -->
  <form id="formCheckout" action="/checkout" method="POST" onsubmit="event.preventDefault(); aggiornaPosizione('formCheckout');">
    <input type="text" name="nome" placeholder="Nome agente" required>
    <input type="hidden" name="lat">
    <input type="hidden" name="lon">
    <button type="submit">Check-Out</button>
  </form>

  <h2>Registro presenze</h2>
  <ul>
    {% for p in presenze %}
      <li>
        {{ p.nome }} - {{ p.tipo }} alle {{ p.orario }}
        {% if p.lat and p.lon %}
          <br><small>üìç Posizione: {{ p.lat }}, {{ p.lon }}</small>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  <!-- Mappa -->
  <h2>Mappa delle posizioni</h2>
  <div id="map" style="height: 300px; border-radius: 10px;"></div>

  <!-- Calendario -->
  <h2>Calendario presenze</h2>
  <div id="calendar"></div>
  <button id="exportPdf">Esporta PDF</button>

  <script>
    // Inizializza mappa Leaflet
    var map = L.map('map').setView([46.244, 11.211], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    {% for p in presenze %}
      {% if p.lat and p.lon %}
        L.marker([{{ p.lat }}, {{ p.lon }}])
          .addTo(map)
          .bindPopup("<b>{{ p.nome }}</b><br>{{ p.tipo }} alle {{ p.orario }}");
      {% endif %}
    {% endfor %}

    // Inizializza FullCalendar con popup al tap per iPhone
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var events = [
            {% for p in presenze %}
                {
                  title: '{{ p.nome }} - {{ p.tipo }}',
                  start: '{{ p.data }}',
                  color: '{{ p.colore }}',
                  orario: '{{ p.orario }}',
                  lat: '{{ p.lat }}',
                  lon: '{{ p.lon }}'
                },
            {% endfor %}
        ];

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: events,
            eventClick: function(info) {
                let msg = info.event.title + "\nOrario: " + info.event.extendedProps.orario;
                if(info.event.extendedProps.lat && info.event.extendedProps.lon){
                    msg += "\nPosizione: " + info.event.extendedProps.lat + ", " + info.event.extendedProps.lon;
                }
                alert(msg); // Popup al tap su iPhone
            }
        });
        calendar.render();
    });

    // Esportazione PDF
    document.getElementById('exportPdf').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Report Presenze - Comune di Salorno", 10, 10);
        let y = 20;
        {% for p in presenze %}
            doc.text("{{ p.nome }} - {{ p.tipo }} alle {{ p.orario }}", 10, y);
            y += 10;
        {% endfor %}
        doc.save("presenze.pdf");
    });
  </script>
</body>
</html>
